# ブランチ運用ガイド

## ブランチ構成

- **main**: 本番環境用ブランチ
- **develop**: STG環境用ブランチ
- **feature/xxx**: 機能開発用ブランチ（`develop` から分岐）
- **hotfix/xxx**: 緊急修正用ブランチ（`main` から分岐）

## ブランチ運用フロー

### 1. 通常の開発フロー
新機能や改修を行う際は、`develop` ブランチから `feature` ブランチを作成します。

その後、GitHub/GitLab等でプルリクエストを作成し、`develop` ブランチへマージします。

レビュー完了後、プルリクエスト画面からマージしてください。

`develop` ブランチの内容がSTG環境に自動デプロイされ、テストを実施します。

STG環境でのテストが完了したら、`main` ブランチを更新します。

**この操作のみコマンドラインから実施します（プルリクエストは使用しません）。**
```bash
# mainブランチに切り替え
git checkout main
git pull origin main

# developブランチの内容をFast-forwardマージ
git merge --ff-only develop

# リモートに反映
git push origin main
```

### 2. 緊急修正（HotFix）フロー

本番環境で緊急の修正が必要な場合は、`main` ブランチから `hotfix` ブランチを作成します。


#### 2-1. mainブランチへのマージ

プルリクエストを作成し、`main` ブランチへマージします。

- **Base**: `main`
- **Compare**: `hotfix/critical-bug`

レビュー完了後、プルリクエスト画面からマージしてください。

#### 2-2. developブランチへの反映（重要！）

`main` へのマージ完了後、もう1つプルリクエストを作成し、`develop` ブランチにも反映します。

- **Base**: `develop`
- **Compare**: `main`

または、`hotfix` ブランチから直接 `develop` へのプルリクエストを作成することもできます。

- **Base**: `develop`
- **Compare**: `hotfix/critical-bug`

**注意**: ホットフィックス後は必ず `develop` ブランチにも反映し、ブランチ間の同期を保つこと。


## なぜdevelop→mainのみFast-forwardマージを採用するのか

### develop → main の更新について

`develop` から `main` への更新は、プルリクエストを使わず、コマンドラインからFast-forwardマージを行います。

#### 採用理由

1. **履歴が一直線に保たれる**
   - マージコミットが作成されないため、コミット履歴がシンプルで追跡しやすい
   - `git log` で見たときに、どのコミットが本番に反映されているか一目瞭然

2. **ブランチ間の差分が生じない**
   - `main` と `develop` が常に同じコミットを指すため、意図しない差分が発生しない
   - 次回のリリース時も同様の手順で更新できる

3. **安全性が高い**
   - `--ff-only` オプションにより、Fast-forwardできない状態（mainとdevelopが分岐している状態）ではエラーになる
   - 意図しないマージコミットの作成を防げる

4. **リリースフローの明確化**
   - プルリクエストは「コードレビューが必要な変更」に使用
   - `develop` → `main` は「STG環境で承認済みのコードを本番に反映する」という性質上、レビュープロセスは不要

### その他のマージについて

`feature` → `develop` や `hotfix` → `main` などは、コードレビューが必要なため、プルリクエストを使用します。これにより、以下のメリットがあります:

- コードレビューの実施
- CI/CDによる自動テストの実行
- 変更内容の可視化と議論
- 承認プロセスの記録

### Fast-forwardマージができない場合

もし `--ff-only` でエラーが発生した場合、`main` ブランチに `develop` にない変更が含まれています。これは運用ルール違反なので、以下を確認してください:

- `main` ブランチへ直接コミットしていないか
- ホットフィックスなどで `main` を更新した後、`develop` へマージし忘れていないか

## 運用ルール

### ✅ DO（推奨）

- `feature` ブランチは `develop` から作成する
- `hotfix` ブランチは `main` から作成する
- `feature` → `develop` および `hotfix` → `main` / `develop` はプルリクエストを使用する
- STG環境でのテスト完了後、Fast-forwardマージで `main` を更新する（プルリクなし）
- ホットフィックス後は必ず `develop` にもマージする

### ❌ DON'T（禁止）

- `main` ブランチへ直接コミット・プッシュしない
- `develop` ブランチへ直接コミット・プッシュしない（featureブランチ経由で行う）
- `develop` ブランチを削除しない（継続して使用する）
- `main` から `develop` への更新を忘れない（ブランチの同期を保つ）
- `develop` → `main` の更新にプルリクエストを使用しない
