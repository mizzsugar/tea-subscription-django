{% extends 'common/base.html' %}
{% block title %}{{tea.name}} 詳細{% endblock %}
{% block content %}
<div class="container">
<h1>{{ tea.name }}</h1>
<p>{{ tea.description }}</p>
<div class="row">
<div class="col-md-6">
<h2>詳細情報</h2>
<ul class="list-group">
<li class="list-group-item">蒸し度: {{ tea.get_steam_type_display }}</li>
<li class="list-group-item">産地: {{ tea.origin }}</li>
{% if tea.caffeine_free %}
<li class="list-group-item">カフェインレス: ✅</li>
{% endif %}
</ul>
</div>
</div>

<div class="mt-4">
<div class="row">
      {% if user.is_authenticated %}
        {% if tea.is_favorited %}
<form method="post" action="{% url 'cancel_favorite_tea' tea.id %}" class="favorite-form" data-tea-id="{{ tea.id }}">
{% csrf_token %}
<button type="submit" class="btn btn-danger favorite-button">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-suit-heart-fill" viewBox="0 0 16 16">
<path d="M4 1c2.21 0 4 1.755 4 3.92C8 2.755 9.79 1 12 1s4 1.755 4 3.92c0 3.263-3.234 4.414-7.608 9.608a.513.513 0 0 1-.784 0C3.234 9.334 0 8.183 0 4.92 0 2.755 1.79 1 4 1"></path>
</svg>
          お気に入り済み
</button>
</form>
        {% else %}
<form method="post" action="{% url 'add_favorite_tea' tea.id %}" class="favorite-form" data-tea-id="{{ tea.id }}">
{% csrf_token %}
<button type="submit" class="btn btn-outline-danger favorite-button">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-suit-heart-fill" viewBox="0 0 16 16">
<path d="M4 1c2.21 0 4 1.755 4 3.92C8 2.755 9.79 1 12 1s4 1.755 4 3.92c0 3.263-3.234 4.414-7.608 9.608a.513.513 0 0 1-.784 0C3.234 9.334 0 8.183 0 4.92 0 2.755 1.79 1 4 1"></path>
</svg>
          お気に入りに追加
</button>
</form>
        {% endif %}
      {% endif %}
<div>
<span class="like-count" data-tea-id="{{ tea.id }}">{{ tea.favorites_count }}</span> favorites
</div>
</div>
</div>

<!-- レビューセクション -->
<div class="mt-5">
<h2>レビュー</h2>

<!-- レビューフォーム -->
{% if user.is_authenticated %}
  {% if not user_has_reviewed %}
<div class="card mb-4">
<div class="card-body">
<h5 class="card-title">レビューを投稿する</h5>
<form method="post" action="{% url 'add_review' tea.id %}">
{% csrf_token %}
<div class="mb-3">
<label for="{{ review_form.rating.id_for_label }}" class="form-label">{{ review_form.rating.label }}</label>
{{ review_form.rating }}
</div>
<div class="mb-3">
<label for="{{ review_form.content.id_for_label }}" class="form-label">{{ review_form.content.label }}</label>
{{ review_form.content }}
</div>
<button type="submit" class="btn btn-primary">投稿する</button>
</form>
</div>
</div>
  {% else %}
<div class="alert alert-info">
      このお茶には既にレビューを投稿済みです。
</div>
  {% endif %}
{% else %}
<div class="alert alert-warning">
    レビューを投稿するには<a href="{% url 'signin' %}">ログイン</a>してください。
</div>
{% endif %}

<!-- レビュー一覧 -->
<div class="mt-4">
<h3>レビュー一覧 ({{ reviews.count }}件)</h3>
      {% if reviews %}
        {% for review in reviews %}
<div class="card mb-3">
<div class="card-body">
<div class="d-flex justify-content-between">
<h5 class="card-title">{{ review.user.nickname|default:review.user.username }}</h5>
<small class="text-muted">{{ review.created_at|date:"Y年m月d日" }}</small>
</div>
<div class="mb-2">
<span class="text-warning">{{ review.get_star_display }}</span>
</div>
<p class="card-text">{{ review.content }}</p>
</div>
</div>
        {% endfor %}
      {% else %}
<p class="text-muted">まだレビューがありません。最初のレビューを投稿してみませんか？</p>
      {% endif %}
</div>
</div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.favorite-form');
    
    // CSRFトークンを取得する関数
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const teaId = form.dataset.teaId;
            const formData = new FormData(form);
            const url = form.action;
            const button = form.querySelector('.favorite-button');
            const likeCount = document.querySelector(`.like-count[data-tea-id="${teaId}"]`);
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // いいね数を更新
                    likeCount.textContent = data.favorites_count;
                    
                    // ボタンの表示を切り替え
                    if (data.is_favorited) {
                        button.className = 'btn btn-danger favorite-button';
                        button.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-suit-heart-fill" viewBox="0 0 16 16">
<path d="M4 1c2.21 0 4 1.755 4 3.92C8 2.755 9.79 1 12 1s4 1.755 4 3.92c0 3.263-3.234 4.414-7.608 9.608a.513.513 0 0 1-.784 0C3.234 9.334 0 8.183 0 4.92 0 2.755 1.79 1 4 1"></path>
</svg>
                        お気に入り済み`;
                        form.action = data.cancel_url;
                    } else {
                        button.className = 'btn btn-outline-danger favorite-button';
                        button.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-suit-heart-fill" viewBox="0 0 16 16">
<path d="M4 1c2.21 0 4 1.755 4 3.92C8 2.755 9.79 1 12 1s4 1.755 4 3.92c0 3.263-3.234 4.414-7.608 9.608a.513.513 0 0 1-.784 0C3.234 9.334 0 8.183 0 4.92 0 2.755 1.79 1 4 1"></path>
</svg>
                        お気に入りに追加`;
                        form.action = data.add_url;
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    });
});
</script>
{% endblock %}
